<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Mémorisation</title>
    <link rel="stylesheet" href="style.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script src="firebase-config.js"></script>
</head>

<body>

    <div class="admin-container">
        <h1>Gestion des Questions</h1>

        <!-- Section Ajout Manuel -->
        <div class="content-card" style="width: 100%; box-sizing: border-box; margin-bottom: 2rem;">
            <h2>Ajouter une fiche</h2>
            <form id="add-form">
                <div class="form-group">
                    <label for="question">Question</label>
                    <input type="text" id="question" required placeholder="Ex: Quelle est la capitale de l'Allemagne ?">
                </div>

                <div class="form-group">
                    <label for="answer">Réponse</label>
                    <input type="text" id="answer" required placeholder="Ex: Berlin">
                </div>

                <div class="form-group">
                    <label for="image">Image (optionnel)</label>
                    <input type="file" id="image" accept="image/*">

                    <!-- Recherche Pixabay -->
                    <div style="margin-top: 1rem; padding: 1rem; background: #f0f0f0; border-radius: 5px;">
                        <label style="font-size: 0.9rem;">Ou chercher sur Pixabay :</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="pixabay-search" placeholder="Ex: Chien, Berlin..." style="flex: 1;">
                            <button type="button" id="pixabay-btn" style="padding: 0.5rem 1rem;">Chercher</button>
                        </div>
                        <div id="pixabay-results"
                            style="display: flex; gap: 10px; overflow-x: auto; margin-top: 10px; padding-bottom: 5px;">
                        </div>
                        <input type="hidden" id="selected-pixabay-url">
                        <div id="selected-preview"
                            style="margin-top: 10px; font-size: 0.9rem; color: green; display: none;">Image sélectionnée
                            !</div>
                    </div>
                </div>

                <button type="submit" id="submit-btn">Ajouter</button>
            </form>
        </div>

        <!-- Section Import Excel -->
        <div class="content-card"
            style="width: 100%; box-sizing: border-box; margin-bottom: 2rem; border-top: 4px solid var(--secondary-color);">
            <h2>Import en masse (Excel)</h2>
            <p style="font-size: 0.9rem; color: #666;">Copiez vos colonnes Excel (Question [TAB] Réponse) et collez-les
                ici.</p>
            <form id="import-form">
                <div class="form-group">
                    <textarea id="import-text" rows="5"
                        placeholder="Question 1	Réponse 1&#10;Question 2	Réponse 2"></textarea>
                </div>
                <button type="submit" id="import-btn" style="background-color: var(--secondary-color);">Importer la
                    liste</button>
            </form>
        </div>

        <div class="questions-list" id="questions-list">
            <!-- Les questions s'afficheront ici -->
            <p>Chargement des questions...</p>
        </div>
    </div>

    <!-- Modale de Prévisualisation -->
    <div id="preview-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div
            style="background: white; width: 90%; height: 90%; position: relative; display: flex; flex-direction: column;">
            <button onclick="closePreview()"
                style="position: absolute; top: 10px; right: 10px; background: red; z-index: 10; width: auto; padding: 0.5rem;">Fermer</button>
            <iframe id="preview-frame" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>

    <script>
        const form = document.getElementById('add-form');
        const importForm = document.getElementById('import-form');
        const questionsList = document.getElementById('questions-list');
        const submitBtn = document.getElementById('submit-btn');
        const importBtn = document.getElementById('import-btn');

        // Pixabay Elements
        const pixabaySearch = document.getElementById('pixabay-search');
        const pixabayBtn = document.getElementById('pixabay-btn');
        const pixabayResults = document.getElementById('pixabay-results');
        const selectedPixabayUrl = document.getElementById('selected-pixabay-url');
        const selectedPreview = document.getElementById('selected-preview');

        // Preview Elements
        const previewModal = document.getElementById('preview-modal');
        const previewFrame = document.getElementById('preview-frame');

        // Écouter les mises à jour en temps réel
        db.collection("questions").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
            questionsList.innerHTML = '';
            snapshot.forEach((doc) => {
                renderQuestion(doc.id, doc.data());
            });
            if (snapshot.empty) {
                questionsList.innerHTML = '<p>Aucune question pour le moment.</p>';
            }
        });

        // Recherche Pixabay
        pixabayBtn.addEventListener('click', async () => {
            const query = pixabaySearch.value;
            if (!query || query.length < 3) return alert("Entrez au moins 3 caractères");

            if (pixabayApiKey === "39838048-edeef51c8fd008798b4ecbe51") {
                return alert("Veuillez configurer la clé API Pixabay dans firebase-config.js");
            }

            pixabayBtn.textContent = "...";
            pixabayResults.innerHTML = '';

            try {
                const response = await fetch(`https://pixabay.com/api/?key=${pixabayApiKey}&q=${encodeURIComponent(query)}&lang=fr&image_type=photo&per_page=5`);
                const data = await response.json();

                if (data.hits.length > 0) {
                    data.hits.forEach(hit => {
                        const img = document.createElement('img');
                        img.src = hit.previewURL;
                        img.style.height = "80px";
                        img.style.cursor = "pointer";
                        img.style.border = "2px solid transparent";
                        img.style.borderRadius = "4px";

                        img.onclick = () => {
                            // Sélectionner l'image
                            document.querySelectorAll('#pixabay-results img').forEach(i => i.style.border = "2px solid transparent");
                            img.style.border = "2px solid var(--primary-color)";
                            selectedPixabayUrl.value = hit.webformatURL; // URL de meilleure qualité
                            selectedPreview.style.display = 'block';
                            selectedPreview.textContent = "Image sélectionnée (sera téléchargée à l'ajout)";
                        };

                        pixabayResults.appendChild(img);
                    });
                } else {
                    pixabayResults.textContent = "Aucun résultat.";
                }
            } catch (e) {
                console.error(e);
                alert("Erreur Pixabay");
            } finally {
                pixabayBtn.textContent = "Chercher";
            }
        });

        // Ajouter une question (Manuel)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = "Ajout en cours...";

            const question = document.getElementById('question').value;
            const answer = document.getElementById('answer').value;
            const imageFile = document.getElementById('image').files[0];
            const pixabayUrl = selectedPixabayUrl.value;

            let imageUrl = null;

            try {
                // Priorité à l'upload fichier, sinon Pixabay
                if (imageFile) {
                    const storageRef = storage.ref('images/' + new Date().getTime() + '_' + imageFile.name);
                    await storageRef.put(imageFile);
                    imageUrl = await storageRef.getDownloadURL();
                } else if (pixabayUrl) {
                    // Pour Pixabay, on télécharge l'image puis on l'upload sur Firebase pour la pérennité
                    // Note: Fetch d'une URL externe peut être bloqué par CORS. 
                    // Si CORS bloque, on enregistre directement l'URL Pixabay (moins robuste mais fonctionne).
                    try {
                        const response = await fetch(pixabayUrl);
                        const blob = await response.blob();
                        const storageRef = storage.ref('images/' + new Date().getTime() + '_pixabay.jpg');
                        await storageRef.put(blob);
                        imageUrl = await storageRef.getDownloadURL();
                    } catch (corsError) {
                        console.warn("CORS bloqué pour téléchargement image, utilisation URL directe", corsError);
                        imageUrl = pixabayUrl;
                    }
                }

                await db.collection("questions").add({
                    question: question,
                    answer: answer,
                    imageUrl: imageUrl,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                form.reset();
                pixabayResults.innerHTML = '';
                selectedPixabayUrl.value = '';
                selectedPreview.style.display = 'none';
                alert("Question ajoutée avec succès !");
            } catch (error) {
                console.error("Erreur lors de l'ajout:", error);
                alert("Erreur: " + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = "Ajouter";
            }
        });

        // Import en masse
        importForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('import-text').value;
            if (!text.trim()) return;

            importBtn.disabled = true;
            importBtn.textContent = "Importation...";

            const lines = text.trim().split('\n');
            let count = 0;

            try {
                const batch = db.batch();

                for (let line of lines) {
                    // Séparer par tabulation (Excel)
                    const parts = line.split('\t');
                    if (parts.length >= 2) {
                        const q = parts[0].trim();
                        const a = parts[1].trim();

                        if (q && a) {
                            const docRef = db.collection("questions").doc();
                            batch.set(docRef, {
                                question: q,
                                answer: a,
                                imageUrl: null,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            count++;
                        }
                    }
                }

                await batch.commit();
                document.getElementById('import-text').value = '';
                alert(`${count} questions importées avec succès !`);

            } catch (error) {
                console.error("Erreur import:", error);
                alert("Erreur lors de l'importation.");
            } finally {
                importBtn.disabled = false;
                importBtn.textContent = "Importer la liste";
            }
        });

        // Afficher une question dans la liste
        function renderQuestion(id, data) {
            const div = document.createElement('div');
            div.className = 'question-item';

            let imageHtml = '';
            if (data.imageUrl) {
                imageHtml = `<img src="${data.imageUrl}" alt="Image question">`;
            }

            // Echapper les guillemets pour le onclick
            const safeQuestion = data.question.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const safeAnswer = data.answer.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const safeImage = data.imageUrl ? data.imageUrl : '';

            div.innerHTML = `
                ${imageHtml}
                <div class="item-content">
                    <strong>Q: ${data.question}</strong><br>
                    <span style="color: var(--primary-color)">R: ${data.answer}</span>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button onclick="openPreview('${safeQuestion}', '${safeAnswer}', '${safeImage}')" style="padding: 0.5rem; background-color: var(--secondary-color);">Aperçu</button>
                    <button class="delete-btn" onclick="deleteQuestion('${id}', '${data.imageUrl || ''}')">Supprimer</button>
                </div>
            `;
            questionsList.appendChild(div);
        }

        // Prévisualisation
        window.openPreview = (question, answer, imageUrl) => {
            // On écrit dynamiquement dans l'iframe pour isoler le style
            const doc = previewFrame.contentWindow.document;
            doc.open();
            doc.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <link rel="stylesheet" href="style.css">
                    <style>
                        /* Force fullscreen look in iframe */
                        body { height: 100vh; overflow: hidden; }
                        #viewer-container { width: 100%; height: 100%; }
                        .answer-text { opacity: 1 !important; } /* Montrer la réponse direct */
                    </style>
                </head>
                <body>
                    <div id="viewer-container">
                        <div class="content-card">
                            <img class="slide-image ${!imageUrl ? 'hidden' : ''}" src="${imageUrl}" alt="Illustration">
                            <div class="question-text">${question}</div>
                            <div class="answer-text visible">${answer}</div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            doc.close();
            previewModal.style.display = 'flex';
        };

        window.closePreview = () => {
            previewModal.style.display = 'none';
        };

        // Supprimer une question (fonction globale pour être accessible via onclick)
        window.deleteQuestion = async (id, imageUrl) => {
            if (confirm("Voulez-vous vraiment supprimer cette question ?")) {
                try {
                    await db.collection("questions").doc(id).delete();

                    if (imageUrl) {
                        // Essayer de supprimer l'image associée
                        try {
                            const imageRef = storage.refFromURL(imageUrl);
                            await imageRef.delete();
                        } catch (e) {
                            console.log("Erreur suppression image (peut-être déjà supprimée):", e);
                        }
                    }
                } catch (error) {
                    console.error("Erreur suppression:", error);
                    alert("Erreur lors de la suppression.");
                }
            }
        };
    </script>
</body>

</html>