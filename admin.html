<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Mémorisation V3</title>
    <link rel="stylesheet" href="style.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script src="firebase-config.js"></script>
</head>

<body>

    <div class="admin-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1>Gestion des Questions</h1>
            <a href="index.html" target="_blank"
                style="text-decoration: none; background: var(--secondary-color); color: white; padding: 0.5rem 1rem; border-radius: 5px;">Voir
                le Diaporama</a>
        </div>

        <!-- Section Import Excel (Seul moyen d'ajout) -->
        <div class="content-card"
            style="width: 100%; box-sizing: border-box; margin-bottom: 2rem; border-top: 4px solid var(--secondary-color);">
            <h2>Import en masse (Excel)</h2>
            <p style="font-size: 0.9rem; color: #666;">Copiez vos colonnes Excel (Question [TAB] Réponse) ou utilisez le
                format "Question ; Réponse".</p>
            <form id="import-form">
                <div class="form-group">
                    <textarea id="import-text" rows="3"
                        placeholder="Question 1	Réponse 1&#10;Question 2 ; Réponse 2"></textarea>
                </div>
                <button type="submit" id="import-btn" style="background-color: var(--secondary-color);">Importer la
                    liste</button>
            </form>
        </div>

        <div class="questions-list" id="questions-list">
            <!-- Les questions s'afficheront ici en grille -->
            <p>Chargement des questions...</p>
        </div>
    </div>

    <!-- Modale Pixabay -->
    <div id="pixabay-modal">
        <div id="pixabay-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;">Choisir une image</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="removeImage()"
                        style="background: #f39c12; padding: 0.5rem; font-size: 0.9rem;">Supprimer l'image</button>
                    <button onclick="closePixabayModal()" style="background: #e74c3c; padding: 0.5rem;">Fermer</button>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 1rem;">
                <input type="text" id="pixabay-search-input" placeholder="Recherche..." style="flex: 1;">
                <button id="pixabay-search-btn">Chercher</button>
            </div>
            <div id="pixabay-grid"></div>
        </div>
    </div>

    <!-- Modale de Prévisualisation -->
    <div id="preview-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center;">
        <div
            style="background: white; width: 90%; height: 90%; position: relative; display: flex; flex-direction: column;">
            <button onclick="closePreview()"
                style="position: absolute; top: 10px; right: 10px; background: red; z-index: 10; width: auto; padding: 0.5rem;">Fermer</button>
            <iframe id="preview-frame" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>

    <script>
        const importForm = document.getElementById('import-form');
        const questionsList = document.getElementById('questions-list');
        const importBtn = document.getElementById('import-btn');

        // Pixabay Elements
        const pixabayModal = document.getElementById('pixabay-modal');
        const pixabayGrid = document.getElementById('pixabay-grid');
        const pixabaySearchInput = document.getElementById('pixabay-search-input');
        const pixabaySearchBtn = document.getElementById('pixabay-search-btn');

        let currentEditingDocId = null;
        let allQuestions = []; // Stockage local pour le tri

        // Preview Elements
        const previewModal = document.getElementById('preview-modal');
        const previewFrame = document.getElementById('preview-frame');

        // Écouter les mises à jour en temps réel (SANS orderBy côté serveur pour gérer la migration)
        db.collection("questions").onSnapshot((snapshot) => {
            allQuestions = [];
            let needsMigration = false;

            snapshot.forEach((doc) => {
                const data = doc.data();
                allQuestions.push({ id: doc.id, ...data });
                if (typeof data.order === 'undefined') {
                    needsMigration = true;
                }
            });

            // Tri : Par 'order' si possible, sinon par 'createdAt' (fallback)
            allQuestions.sort((a, b) => {
                if (typeof a.order !== 'undefined' && typeof b.order !== 'undefined') {
                    return a.order - b.order;
                }
                // Fallback pour ceux qui n'ont pas d'ordre (les nouveaux ou avant migration)
                const timeA = a.createdAt ? a.createdAt.seconds : 0;
                const timeB = b.createdAt ? b.createdAt.seconds : 0;
                return timeB - timeA; // Plus récent en premier par défaut si pas d'ordre
            });

            renderList();

            if (needsMigration) {
                console.log("Migration des ordres nécessaire...");
                saveNewOrder(); // Assigne un ordre à tout le monde
            }
        });

        function renderList() {
            questionsList.innerHTML = '';
            if (allQuestions.length === 0) {
                questionsList.innerHTML = '<p>Aucune question pour le moment.</p>';
                return;
            }

            allQuestions.forEach((item) => {
                renderQuestion(item.id, item);
            });
        }

        // Import en masse
        importForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('import-text').value;
            if (!text.trim()) return;

            importBtn.disabled = true;
            importBtn.textContent = "Importation...";

            const lines = text.trim().split('\n');
            let count = 0;

            try {
                const batch = db.batch();
                let batchCount = 0;

                // On détermine le prochain 'order' disponible
                const maxOrder = allQuestions.length > 0 ? Math.max(...allQuestions.map(q => q.order || 0)) : -1;
                let currentOrder = maxOrder + 1;

                for (let line of lines) {
                    if (!line.trim()) continue;

                    let parts = line.split('\t');
                    if (parts.length < 2) {
                        parts = line.split(';');
                    }

                    if (parts.length >= 2) {
                        const q = parts[0].trim();
                        const a = parts.slice(1).join(' ').trim();

                        if (q && a) {
                            const docRef = db.collection("questions").doc();
                            batch.set(docRef, {
                                question: q,
                                answer: a,
                                imageUrl: null,
                                order: currentOrder++, // Ajout de l'ordre
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            count++;
                            batchCount++;
                        }
                    }
                }

                if (batchCount > 0) {
                    await batch.commit();
                    document.getElementById('import-text').value = '';
                    console.log(`${count} questions importées.`);
                } else {
                    alert("Format incorrect. Utilisez 'Question [TAB] Réponse' ou 'Question ; Réponse'");
                }

            } catch (error) {
                console.error("Erreur import:", error);
                alert("Erreur lors de l'importation: " + error.message);
            } finally {
                importBtn.disabled = false;
                importBtn.textContent = "Importer la liste";
            }
        });

        // Afficher une question (Carte V3 + Drag & Drop)
        function renderQuestion(id, data) {
            const div = document.createElement('div');
            div.className = 'question-item';
            div.id = `item-${id}`;
            div.setAttribute('draggable', 'true'); // Rend l'élément glissable
            div.dataset.id = id;

            // Drag Events
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragend', handleDragEnd);

            // Image Placeholder Logic
            let imgContent = `<span>Cliquez pour ajouter une image<br>(Pixabay)</span>`;
            if (data.imageUrl) {
                imgContent = `<img src="${data.imageUrl}" alt="Image">`;
            }

            const safeQuestion = (data.question || "").replace(/\\/g, '\\\\').replace(/"/g, '&quot;').replace(/'/g, "\\'").replace(/\n/g, ' ');
            const safeAnswer = (data.answer || "").replace(/\\/g, '\\\\').replace(/"/g, '&quot;').replace(/'/g, "\\'").replace(/\n/g, ' ');
            const safeImage = data.imageUrl ? data.imageUrl : '';

            div.innerHTML = `
                <div class="img-placeholder" onclick="openPixabayFor('${id}', '${safeQuestion}')">
                    ${imgContent}
                </div>
                
                <div class="item-content" id="content-${id}">
                    <div class="q-val" style="font-weight:bold; margin-bottom:0.5rem;">${data.question}</div>
                    <div class="a-val" style="color:var(--primary-color);">${data.answer}</div>
                </div>

                <div class="item-actions">
                    <button class="edit-btn" onclick="toggleEdit('${id}')">Modifier</button>
                    <button onclick="openPreview('${safeQuestion}', '${safeAnswer}', '${safeImage}')" style="background-color: var(--secondary-color);">Aperçu</button>
                    <button class="delete-btn" onclick="deleteQuestion('${id}', '${data.imageUrl || ''}')">Supprimer</button>
                </div>
            `;
            questionsList.appendChild(div);
        }

        // --- Drag & Drop Logic ---
        let dragSrcEl = null;

        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault(); // Nécessaire pour permettre le drop
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (dragSrcEl !== this) {
                // Réorganisation visuelle (swap simple ou réinsertion)
                // Ici on va plutôt réordonner le tableau allQuestions et re-render
                const srcId = dragSrcEl.dataset.id;
                const destId = this.dataset.id;

                const srcIndex = allQuestions.findIndex(q => q.id === srcId);
                const destIndex = allQuestions.findIndex(q => q.id === destId);

                if (srcIndex > -1 && destIndex > -1) {
                    // Déplacer l'élément dans le tableau
                    const [movedItem] = allQuestions.splice(srcIndex, 1);
                    allQuestions.splice(destIndex, 0, movedItem);

                    renderList(); // Mettre à jour l'UI immédiatement
                    saveNewOrder(); // Sauvegarder le nouvel ordre dans Firebase
                }
            }
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            // Nettoyer les classes si besoin
        }

        async function saveNewOrder() {
            const batch = db.batch();
            allQuestions.forEach((q, index) => {
                // On ne met à jour que si l'ordre a changé pour économiser des écritures
                if (q.order !== index) {
                    const ref = db.collection("questions").doc(q.id);
                    batch.update(ref, { order: index });
                }
            });

            try {
                await batch.commit();
                console.log("Ordre sauvegardé !");
            } catch (e) {
                console.error("Erreur sauvegarde ordre:", e);
            }
        }

        // --- Gestion Pixabay ---
        window.openPixabayFor = (id, initialQuery) => {
            currentEditingDocId = id;
            pixabayModal.style.display = 'flex';
            pixabaySearchInput.value = initialQuery;
            searchPixabay(initialQuery);
        };

        window.closePixabayModal = () => {
            pixabayModal.style.display = 'none';
            currentEditingDocId = null;
        };

        pixabaySearchBtn.addEventListener('click', () => {
            searchPixabay(pixabaySearchInput.value);
        });

        pixabaySearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchPixabay(pixabaySearchInput.value);
            }
        });

        async function searchPixabay(query) {
            if (!query) return;
            pixabayGrid.innerHTML = '<p style="text-align:center; width:100%;">Chargement...</p>';

            try {
                if (typeof pixabayApiKey === 'undefined' || pixabayApiKey === "VOTRE_CLE_PIXABAY") {
                    pixabayGrid.innerHTML = '<p style="color:red;">Clé API Pixabay manquante dans firebase-config.js</p>';
                    return;
                }

                const response = await fetch(`https://pixabay.com/api/?key=${pixabayApiKey}&q=${encodeURIComponent(query)}&lang=fr&image_type=photo&per_page=100`);
                const data = await response.json();

                pixabayGrid.innerHTML = '';
                if (data.hits && data.hits.length > 0) {
                    data.hits.forEach(hit => {
                        const img = document.createElement('img');
                        img.src = hit.webformatURL;
                        img.onclick = () => selectImage(hit.webformatURL);
                        pixabayGrid.appendChild(img);
                    });
                } else {
                    pixabayGrid.innerHTML = '<p>Aucune image trouvée.</p>';
                }
            } catch (e) {
                console.error(e);
                pixabayGrid.innerHTML = '<p>Erreur lors de la recherche.</p>';
            }
        }

        async function selectImage(url) {
            if (!currentEditingDocId) {
                alert("Erreur: Aucune question sélectionnée.");
                return;
            }

            const docIdToUpdate = currentEditingDocId;

            const placeholder = document.querySelector(`#item-${docIdToUpdate} .img-placeholder`);
            if (placeholder) placeholder.innerHTML = '<span>Sauvegarde...</span>';

            closePixabayModal();

            try {
                await db.collection("questions").doc(docIdToUpdate).set({
                    imageUrl: url
                }, { merge: true });

            } catch (error) {
                console.error("Erreur update image:", error);
                alert("Erreur lors de la sauvegarde de l'image: " + error.message);
            }
        }

        window.removeImage = async () => {
            if (!currentEditingDocId) return;

            if (!confirm("Voulez-vous vraiment retirer l'image de cette question ?")) return;

            const docIdToUpdate = currentEditingDocId;
            closePixabayModal();

            try {
                await db.collection("questions").doc(docIdToUpdate).update({
                    imageUrl: null
                });
            } catch (error) {
                console.error("Erreur suppression image:", error);
                alert("Erreur lors de la suppression de l'image: " + error.message);
            }
        };

        // --- Gestion Édition ---
        window.toggleEdit = (id) => {
            const contentDiv = document.getElementById(`content-${id}`);
            const isEditing = contentDiv.classList.contains('editing');

            if (!isEditing) {
                const qVal = contentDiv.querySelector('.q-val').textContent;
                const aVal = contentDiv.querySelector('.a-val').textContent;

                contentDiv.innerHTML = `
                    <input type="text" class="edit-q" value="${qVal.replace(/"/g, '&quot;')}" style="margin-bottom:0.5rem;">
                    <input type="text" class="edit-a" value="${aVal.replace(/"/g, '&quot;')}" style="margin-bottom:0.5rem;">
                    <button class="save-btn" onclick="saveEdit('${id}')" style="margin-top:0.5rem; width:100%;">Sauvegarder</button>
                `;
                contentDiv.classList.add('editing');
            }
        };

        window.saveEdit = async (id) => {
            const contentDiv = document.getElementById(`content-${id}`);
            const qInput = contentDiv.querySelector('.edit-q').value;
            const aInput = contentDiv.querySelector('.edit-a').value;

            try {
                await db.collection("questions").doc(id).update({
                    question: qInput,
                    answer: aInput
                });
            } catch (error) {
                console.error("Erreur update:", error);
                alert("Erreur lors de la modification: " + error.message);
            }
        };

        // --- Suppression Instantanée ---
        window.deleteQuestion = async (id, imageUrl) => {
            try {
                document.getElementById(`item-${id}`).style.opacity = '0.5';
                await db.collection("questions").doc(id).delete();

                if (imageUrl && imageUrl.includes('firebasestorage')) {
                    try {
                        const imageRef = storage.refFromURL(imageUrl);
                        await imageRef.delete();
                    } catch (e) { console.log("Info: Image déjà supprimée ou externe"); }
                }
            } catch (error) {
                console.error("Erreur suppression:", error);
                alert("Erreur lors de la suppression: " + error.message);
                document.getElementById(`item-${id}`).style.opacity = '1';
            }
        };

        // --- Prévisualisation (Inchangé) ---
        window.openPreview = (question, answer, imageUrl) => {
            const doc = previewFrame.contentWindow.document;
            doc.open();
            doc.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <link rel="stylesheet" href="style.css">
                    <style>
                        body { height: 100vh; overflow: hidden; }
                        #viewer-container { width: 100%; height: 100%; }
                        .answer-text { opacity: 1 !important; }
                    </style>
                </head>
                <body>
                    <div id="viewer-container">
                        <div class="content-card">
                            <img class="slide-image ${!imageUrl ? 'hidden' : ''}" src="${imageUrl}" alt="Illustration">
                            <div class="question-text">${question}</div>
                            <div class="answer-text visible">${answer}</div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            doc.close();
            previewModal.style.display = 'flex';
        };

        window.closePreview = () => {
            previewModal.style.display = 'none';
        };

    </script>
</body>

</html>