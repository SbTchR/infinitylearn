<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mémorisation - Diaporama</title>
    <link rel="stylesheet" href="style.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script src="firebase-config.js"></script>
</head>

<body>

    <div id="viewer-container">
        <div class="content-card">
            <img id="slide-image" class="slide-image hidden" src="" alt="Illustration">
            <div id="question-text" class="question-text">Chargement...</div>
            <div id="answer-text" class="answer-text"></div>
        </div>
        <div id="progress-bar" class="progress-bar"></div>
        <div id="countdown-timer"></div>
    </div>

    <script>
        const questionEl = document.getElementById('question-text');
        const answerEl = document.getElementById('answer-text');
        const imageEl = document.getElementById('slide-image');
        const progressBar = document.getElementById('progress-bar');
        const timerEl = document.getElementById('countdown-timer');

        let questions = [];
        let currentIndex = 0;
        let timerInterval;

        // Configuration des durées (en ms)
        const QUESTION_DURATION = 10000; // 10 secondes
        const ANSWER_DURATION = 5000;    // 5 secondes

        // Chargement des données
        db.collection("questions").get().then((querySnapshot) => {
            questions = [];
            querySnapshot.forEach((doc) => {
                questions.push(doc.data());
            });

            if (questions.length > 0) {
                startSlideshow();
            } else {
                questionEl.textContent = "Aucune question disponible.";
            }
        }).catch((error) => {
            console.error("Erreur de chargement:", error);
            questionEl.textContent = "Erreur de chargement des données. Vérifiez la console.";
        });

        function startSlideshow() {
            showQuestion();
        }

        function showQuestion() {
            if (questions.length === 0) return;

            const currentItem = questions[currentIndex];

            // Reset UI
            clearInterval(timerInterval);
            timerEl.style.display = 'none';
            answerEl.classList.remove('visible');
            answerEl.textContent = currentItem.answer;

            questionEl.textContent = currentItem.question;

            if (currentItem.imageUrl) {
                imageEl.src = currentItem.imageUrl;
                imageEl.classList.remove('hidden');
            } else {
                imageEl.classList.add('hidden');
            }

            // Animation barre de progression pour la question
            runProgressBar(QUESTION_DURATION, () => {
                showAnswer();
            });
        }

        function showAnswer() {
            answerEl.classList.add('visible');

            // Afficher et gérer le timer numérique
            timerEl.style.display = 'block';
            let timeLeft = ANSWER_DURATION / 1000;
            timerEl.textContent = timeLeft;

            timerInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft > 0) {
                    timerEl.textContent = timeLeft;
                } else {
                    clearInterval(timerInterval);
                }
            }, 1000);

            // Reset barre de progression
            progressBar.style.transition = 'none';
            progressBar.style.width = '0%';

            setTimeout(() => {
                // Passer à la suivante
                currentIndex = (currentIndex + 1) % questions.length;
                showQuestion();
            }, ANSWER_DURATION);
        }

        function runProgressBar(duration, callback) {
            progressBar.style.transition = 'none';
            progressBar.style.width = '0%';

            // Force reflow
            void progressBar.offsetWidth;

            progressBar.style.transition = `width ${duration}ms linear`;
            progressBar.style.width = '100%';

            setTimeout(callback, duration);
        }

    </script>
</body>

</html>
